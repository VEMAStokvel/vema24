<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Loan Management System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/12.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/12.0.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore-compat.js"></script>
    <style>
        .loading-spinner {
            border: 2px solid #f3f3f3;
            border-top: 2px solid #3498db;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 5px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .card-hover:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }
        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.7);
        }
        .loan-detail-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1rem;
        }
        .outstanding-balance {
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .outstanding-balance:hover {
            background-color: #f0f9ff;
            border-radius: 4px;
            padding: 2px 4px;
        }
        .payment-history {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #e2e8f0;
            border-radius: 0.375rem;
            padding: 0.5rem;
            margin-top: 1rem;
        }
        .progress-bar {
            height: 8px;
            background-color: #e2e8f0;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 4px;
        }
        .progress-fill {
            height: 100%;
            background-color: #3b82f6;
            border-radius: 4px;
            transition: width 0.3s ease;
        }
        .payment-item {
            border-bottom: 1px solid #e2e8f0;
            padding: 8px 0;
        }
        .payment-item:last-child {
            border-bottom: none;
        }
        .summary-card {
            transition: all 0.3s ease;
        }
        .summary-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        .status-badge {
            padding: 0.25rem 0.5rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <!-- Navigation -->
    <nav class="bg-blue-800 text-white shadow-lg">
        <div class="container mx-auto px-4">
            <div class="flex justify-between items-center py-4">
                <div class="flex items-center space-x-2">
                    <i class="fas fa-hand-holding-usd fa-2x"></i>
                    <h1 class="text-2xl font-bold">Loan Management System</h1>
                </div>
                <div class="flex items-center space-x-4">
                    <button id="debug-toggle" class="bg-gray-600 hover:bg-gray-700 px-4 py-2 rounded">
                        <i class="fas fa-bug"></i> Debug
                    </button>
                    <button id="logout-btn" class="bg-red-600 hover:bg-red-700 px-4 py-2 rounded">
                        <i class="fas fa-sign-out-alt"></i> Logout
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <div class="container mx-auto px-4 py-6">
        <!-- Debug Panel -->
        <div id="debug-panel" class="bg-gray-100 border-l-4 border-gray-500 p-4 mt-4 hidden">
            <h3 class="font-bold mb-2">Debug Information</h3>
            <div id="debug-content" class="text-sm font-mono"></div>
        </div>

        <!-- Loading Indicator -->
        <div id="loading-indicator" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="bg-white rounded-lg p-6 flex items-center space-x-4">
                <div class="loading-spinner"></div>
                <p id="loading-text">Loading...</p>
            </div>
        </div>

        <!-- Status Messages -->
        <div id="status-messages" class="fixed top-4 right-4 z-50 space-y-3"></div>

        <!-- Loan View Modal -->
        <div id="loan-view-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden modal-overlay">
            <div class="bg-white rounded-lg shadow-xl w-11/12 md:w-3/4 lg:w-3/5 xl:w-1/2 max-h-screen overflow-y-auto">
                <div class="p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-2xl font-bold text-gray-800">Loan Application Details</h3>
                        <button id="close-view-modal" class="text-gray-500 hover:text-gray-700">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>
                    
                    <div id="loan-details-content" class="loan-detail-grid">
                        <!-- Loan details will be populated here -->
                    </div>
                    
                    <div class="mt-8 flex justify-end">
                        <button id="close-view-modal-btn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">
                            Close
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Payment History Modal -->
        <div id="payment-history-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden modal-overlay">
            <div class="bg-white rounded-lg shadow-xl w-11/12 md:w-2/3 lg:w-1/2">
                <div class="p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-2xl font-bold text-gray-800">Payment History</h3>
                        <button id="close-payment-history-modal" class="text-gray-500 hover:text-gray-700">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>
                    
                    <div id="payment-history-content" class="payment-history">
                        <!-- Payment history will be populated here -->
                    </div>
                    
                    <div class="mt-8 flex justify-end">
                        <button id="close-payment-history-btn" class="bg-blue-600 hover:blue-700 text-white px-4 py-2 rounded">
                            Close
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Payment Modal -->
        <div id="payment-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden modal-overlay">
            <div class="bg-white rounded-lg shadow-xl w-11/12 md:w-1/2 lg:w-1/3">
                <div class="p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-2xl font-bold text-gray-800">Record Payment</h3>
                        <button id="close-payment-modal" class="text-gray-500 hover:text-gray-700">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-bold mb-2" for="payment-amount">
                            Payment Amount (R)
                        </label>
                        <input type="number" step="0.01" min="0" id="payment-amount" class="shadow border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                    </div>

                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-bold mb-2" for="payment-date">
                            Payment Date
                        </label>
                        <input type="date" id="payment-date" class="shadow border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                    </div>

                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-bold mb-2" for="payment-reference">
                            Reference Number
                        </label>
                        <input type="text" id="payment-reference" class="shadow border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" placeholder="Payment reference">
                    </div>
                    
                    <div class="mt-8 flex justify-end space-x-4">
                        <button id="cancel-payment-btn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-4 py-2 rounded">
                            Cancel
                        </button>
                        <button id="save-payment-btn" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded">
                            Record Payment
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Loan Management Section -->
        <section id="loans-section" class="dashboard-section active">
            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">Loan Management Dashboard</h2>
                
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
                    <div class="bg-blue-100 p-4 rounded-lg shadow summary-card">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="text-blue-800 font-semibold">Total Loans</p>
                                <p id="total-loans" class="text-3xl font-bold text-blue-800">0</p>
                            </div>
                            <i class="fas fa-hand-holding-usd text-blue-800 text-2xl"></i>
                        </div>
                    </div>
                    
                    <div class="bg-green-100 p-4 rounded-lg shadow summary-card">
                        <div class="flex justify-between items start">
                            <div>
                                <p class="text-green-800 font-semibold">Active Loans</p>
                                <p id="active-loans" class="text-3xl font-bold text-green-800">0</p>
                            </div>
                            <i class="fas fa-check-circle text-green-800 text-2xl"></i>
                        </div>
                    </div>
                    
                    <div class="bg-purple-100 p-4 rounded-lg shadow summary-card">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="text-purple-800 font-semibold">Total Loan Value</p>
                                <p id="total-loan-value" class="text-3xl font-bold text-purple-800">R0</p>
                            </div>
                            <i class="fas fa-money-bill-wave text-purple-800 text-2xl"></i>
                        </div>
                    </div>

                    <div class="bg-amber-100 p-4 rounded-lg shadow summary-card">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="text-amber-800 font-semibold">Pending Approval</p>
                                <p id="pending-loans" class="text-3xl font-bold text-amber-800">0</p>
                            </div>
                            <i class="fas fa-clock text-amber-800 text-2xl"></i>
                        </div>
                    </div>
                </div>
                
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Borrower</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Loan Amount</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Outstanding</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Progress</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Applied On</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="loans-table-body" class="bg-white divide-y divide-gray-200">
                            <tr>
                                <td colspan="7" class="px-6 py-4 text-center text-gray-500">
                                    Loading loans data...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </section>
    </div>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAEik5dGton3H4LyGDzYbNrw6GwutGNOqk",
            authDomain: "vema-7606a.firebaseapp.com",
            projectId: "vema-7606a",
            storageBucket: "vema-7606a.firebasestorage.app",
            messagingSenderId: "127492940070",
            appId: "1:127492940070:web:ddf247a2cb0723ddcbe1e7",
            measurementId: "G-2E6VC65Q3K"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        // DOM elements
        const loadingIndicator = document.getElementById('loading-indicator');
        const loadingText = document.getElementById('loading-text');
        const statusMessages = document.getElementById('status-messages');
        const debugPanel = document.getElementById('debug-panel');
        const debugContent = document.getElementById('debug-content');
        
        // Modal elements
        const loanViewModal = document.getElementById('loan-view-modal');
        const loanDetailsContent = document.getElementById('loan-details-content');
        const paymentModal = document.getElementById('payment-modal');
        const paymentHistoryModal = document.getElementById('payment-history-modal');
        const paymentHistoryContent = document.getElementById('payment-history-content');
        
        // State variables
        let currentPaymentLoan = null;
        let allLoans = [];

        // Show/hide functions
        function showLoading(message = 'Loading...') {
            loadingText.textContent = message;
            loadingIndicator.classList.remove('hidden');
        }
        
        function hideLoading() {
            loadingIndicator.classList.add('hidden');
        }
        
        function showMessage(type, title, details) {
            const messageEl = document.createElement('div');
            messageEl.className = `p-4 rounded-lg shadow-lg ${type === 'error' ? 'bg-red-500' : 'bg-green-500'} text-white max-w-md`;
            messageEl.innerHTML = `
                <div class="flex justify-between items-start">
                    <div>
                        <strong class="font-bold">${title}</strong>
                        <p class="text-sm mt-1">${details}</p>
                    </div>
                    <button class="ml-4 text-white hover:text-gray-200">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
            
            // Add to messages container
            statusMessages.appendChild(messageEl);
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                messageEl.remove();
            }, 5000);
            
            // Add click handler to close button
            messageEl.querySelector('button').addEventListener('click', () => {
                messageEl.remove();
            });
        }

        // Debug logging
        function logDebug(message, data = null) {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.innerHTML = `<span class="text-gray-600">[${timestamp}]</span> ${message}`;
            
            if (data) {
                const pre = document.createElement('pre');
                pre.className = 'ml-4 mt-1 text-xs';
                pre.textContent = typeof data === 'string' ? data : JSON.stringify(data, null, 2);
                logEntry.appendChild(pre);
            }
            
            debugContent.appendChild(logEntry);
            debugContent.scrollTop = debugContent.scrollHeight;
        }

        // Format currency
        function formatCurrency(amount) {
            if (!amount && amount !== 0) return 'R0.00';
            return 'R' + parseFloat(amount).toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,');
        }
        
        // Format date
        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            
            try {
                const date = dateString.toDate ? dateString.toDate() : new Date(dateString);
                return date.toLocaleDateString('en-ZA', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                });
            } catch (error) {
                console.error('Error formatting date:', error);
                return 'Invalid Date';
            }
        }

        // Get status badge class
        function getStatusClass(status) {
            switch(status) {
                case 'Active':
                    return 'bg-green-100 text-green-800';
                case 'Approved':
                    return 'bg-blue-100 text-blue-800';
                case 'Pending':
                    return 'bg-yellow-100 text-yellow-800';
                case 'Rejected':
                    return 'bg-red-100 text-red-800';
                case 'Paid':
                    return 'bg-purple-100 text-purple-800';
                default:
                    return 'bg-gray-100 text-gray-800';
            }
        }
        
        // Load loan details for viewing
        async function viewLoanDetails(userId, loanId) {
            showLoading('Loading loan details...');
            
            try {
                // Get the loan document
                const loanDoc = await db.collection('users').doc(userId).collection('loans').doc(loanId).get();
                
                if (!loanDoc.exists) {
                    throw new Error('Loan application not found');
                }
                
                const loanData = loanDoc.data();
                
                // Get user details
                const userDoc = await db.collection('users').doc(userId).get();
                const userData = userDoc.data();
                
                // Format the loan data for display
                const formattedData = {
                    // Personal Information
                    'Applicant Name': loanData.fullName || 'N/A',
                    'ID Number': loanData.idNumber || 'N/A',
                    'Phone Number': loanData.phoneNumber || 'N/A',
                    'Email Address': loanData.email || 'N/A',
                    'Residential Address': loanData.address || 'N/A',
                    
                    // Employment Information
                    'Employer': loanData.employer || 'N/A',
                    'Job Title': loanData.jobTitle || 'N/A',
                    'Work Address': loanData.workAddress || 'N/A',
                    'Work Contact': loanData.workContact || 'N/A',
                    'Employment Date': formatDate(loanData.employmentDate),
                    
                    // Financial Information
                    'Gross Salary': formatCurrency(loanData.grossSalary || 0),
                    'Net Salary': formatCurrency(loanData.netSalary || 0),
                    'Other Income': formatCurrency(loanData.otherIncome || 0),
                    
                    // Expenses
                    'Rent': formatCurrency(loanData.rent || 0),
                    'Food': formatCurrency(loanData.food || 0),
                    'Transport': formatCurrency(loanData.transport || 0),
                    'Existing Loans': formatCurrency(loanData.existingLoans || 0),
                    'Other Expenses': formatCurrency(loanData.otherExpenses || 0),
                    
                    // Loan Details
                    'Loan Amount': formatCurrency(loanData.loanAmount || 0),
                    'Outstanding Balance': formatCurrency(loanData.outstandingBalance || loanData.loanAmount || 0),
                    'Loan Term': loanData.loanTerm ? `${loanData.loanTerm} months` : 'N/A',
                    'Loan Purpose': loanData.purpose || 'N/A',
                    'Monthly Repayment': loanData.monthlyRepayment ? formatCurrency(loanData.monthlyRepayment) : 'N/A',
                    'Total Repayment': loanData.totalRepayment ? formatCurrency(loanData.totalRepayment) : 'N/A',
                    'Interest Rate': loanData.interestRate ? `${loanData.interestRate}%` : 'N/A',
                    
                    // Application Metadata
                    'Application Date': formatDate(loanData.applicationDate),
                    'Status': loanData.status || 'Pending',
                    'User ID': userId,
                    'User Email': userData.email || 'N/A'
                };
                
                // Generate HTML for the loan details
                let detailsHtml = '';
                
                for (const [key, value] of Object.entries(formattedData)) {
                    detailsHtml += `
                        <div class="mb-4">
                            <h4 class="font-semibold text-gray-700">${key}</h4>
                            <p class="text-gray-900">${value}</p>
                        </div>
                    `;
                }
                
                // Add document links if available
                detailsHtml += `<div class="mb-4 col-span-full"><h4 class="font-semibold text-gray-700 mb-2">Attached Documents</h4><div class="flex flex-wrap gap-2">`;
                
                if (loanData.idDocumentUrl) {
                    detailsHtml += `<a href="${loanData.idDocumentUrl}" target="_blank" class="bg-blue-100 text-blue-800 px-3 py-1 rounded text-sm hover:bg-blue-200">ID Document</a>`;
                }
                
                if (loanData.payslipUrl) {
                    detailsHtml += `<a href="${loanData.payslipUrl}" target="_blank" class="bg-blue-100 text-blue-800 px-3 py-1 rounded text-sm hover:bg-blue-200">Payslip</a>`;
                }
                
                if (loanData.bankStatementUrl) {
                    detailsHtml += `<a href="${loanData.bankStatementUrl}" target="_blank" class="bg-blue-100 text-blue-800 px-3 py-1 rounded text-sm hover:bg-blue-200">Bank Statement</a>`;
                }
                
                if (loanData.employmentConfirmationUrl) {
                    detailsHtml += `<a href="${loanData.employmentConfirmationUrl}" target="_blank" class="bg-blue-100 text-blue-800 px-3 py-1 rounded text-sm hover:bg-blue-200">Employment Confirmation</a>`;
                }
                
                detailsHtml += `</div></div>`;
                
                // Update modal content
                loanDetailsContent.innerHTML = detailsHtml;
                
                // Show the modal
                loanViewModal.classList.remove('hidden');
                
            } catch (error) {
                showMessage('error', 'Load Error', 'Failed to load loan details: ' + error.message);
                console.error('Error loading loan details:', error);
                logDebug('Error loading loan details:', error.message);
            } finally {
                hideLoading();
            }
        }

        // Load payment history
        async function viewPaymentHistory(userId, loanId) {
            showLoading('Loading payment history...');
            
            try {
                // Get payment history
                const paymentsSnapshot = await db.collection('users')
                    .doc(userId)
                    .collection('loans')
                    .doc(loanId)
                    .collection('payments')
                    .orderBy('date', 'desc')
                    .get();
                
                let paymentsHtml = '';
                
                if (paymentsSnapshot.empty) {
                    paymentsHtml = '<p class="text-gray-500 text-center py-4">No payment history found.</p>';
                } else {
                    paymentsHtml = `
                        <div class="mb-4 p-3 bg-gray-50 rounded-lg">
                            <h4 class="font-semibold text-gray-700">Payment Summary</h4>
                            <div class="flex justify-between mt-2">
                                <span>Total Paid:</span>
                                <span class="font-bold" id="total-paid-amount">Calculating...</span>
                            </div>
                        </div>
                        <div class="divide-y divide-gray-200">
                    `;
                    
                    let totalPayments = 0;
                    
                    paymentsSnapshot.forEach((doc) => {
                        const payment = doc.data();
                        const amount = parseFloat(payment.amount);
                        totalPayments += amount;
                        
                        paymentsHtml += `
                            <div class="payment-item">
                                <div class="flex justify-between items-center">
                                    <div>
                                        <div class="font-medium">${formatDate(payment.date)}</div>
                                        <div class="text-sm text-gray-500">${payment.reference || 'No reference'}</div>
                                    </div>
                                    <div class="text-green-600 font-semibold">${formatCurrency(amount)}</div>
                                </div>
                            </div>
                        `;
                    });
                    
                    paymentsHtml += `</div>`;
                    
                    // Update total paid amount
                    setTimeout(() => {
                        document.getElementById('total-paid-amount').textContent = formatCurrency(totalPayments);
                    }, 100);
                }
                
                paymentHistoryContent.innerHTML = paymentsHtml;
                paymentHistoryModal.classList.remove('hidden');
                
            } catch (error) {
                showMessage('error', 'Load Error', 'Failed to load payment history: ' + error.message);
                console.error('Error loading payment history:', error);
                logDebug('Error loading payment history:', error.message);
            } finally {
                hideLoading();
            }
        }

        // Open payment modal
        function openPaymentModal(loan) {
            currentPaymentLoan = loan;
            
            // Set today's date as default
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('payment-date').value = today;
            
            // Set maximum payment amount as outstanding balance
            const outstanding = parseFloat(loan.outstandingBalance || loan.loanAmount);
            document.getElementById('payment-amount').setAttribute('max', outstanding);
            
            // Clear previous values
            document.getElementById('payment-amount').value = '';
            document.getElementById('payment-reference').value = '';
            
            // Show the modal
            paymentModal.classList.remove('hidden');
        }

        // Save payment
        async function savePayment() {
            if (!currentPaymentLoan) return;
            
            showLoading('Recording payment...');
            
            try {
                const paymentAmount = parseFloat(document.getElementById('payment-amount').value);
                const paymentDate = document.getElementById('payment-date').value;
                const paymentReference = document.getElementById('payment-reference').value;
                
                if (!paymentAmount || paymentAmount <= 0) {
                    throw new Error('Please enter a valid payment amount');
                }
                
                if (!paymentDate) {
                    throw new Error('Please select a payment date');
                }
                
                // Get current loan data
                const loanDoc = await db.collection('users')
                    .doc(currentPaymentLoan.userId)
                    .collection('loans')
                    .doc(currentPaymentLoan.id)
                    .get();
                
                if (!loanDoc.exists) {
                    throw new Error('Loan not found');
                }
                
                const loanData = loanDoc.data();
                const currentOutstanding = parseFloat(loanData.outstandingBalance || loanData.loanAmount);
                
                if (paymentAmount > currentOutstanding) {
                    throw new Error('Payment amount cannot exceed outstanding balance');
                }
                
                // Calculate new outstanding balance
                const newOutstanding = currentOutstanding - paymentAmount;
                
                // Create payment record
                const paymentData = {
                    amount: paymentAmount,
                    date: new Date(paymentDate),
                    reference: paymentReference,
                    recordedAt: new Date(),
                    loanId: currentPaymentLoan.id,
                    userId: currentPaymentLoan.userId
                };
                
                // Use a batch write to ensure both operations succeed or fail together
                const batch = db.batch();
                
                const loanRef = db.collection('users')
                    .doc(currentPaymentLoan.userId)
                    .collection('loans')
                    .doc(currentPaymentLoan.id);
                
                // Update loan outstanding balance
                batch.update(loanRef, {
                    outstandingBalance: newOutstanding,
                    updatedAt: new Date()
                });
                
                // Add payment to payments subcollection
                const paymentRef = db.collection('users')
                    .doc(currentPaymentLoan.userId)
                    .collection('loans')
                    .doc(currentPaymentLoan.id)
                    .collection('payments')
                    .doc();
                
                batch.set(paymentRef, paymentData);
                
                // If paid in full, update status
                if (newOutstanding <= 0) {
                    batch.update(loanRef, {
                        status: 'Paid'
                    });
                }
                
                // Commit the batch
                await batch.commit();
                
                // Close the modal
                paymentModal.classList.add('hidden');
                
                // Show success message
                showMessage('success', 'Payment Recorded', 'Payment has been recorded successfully.');
                
                // Refresh the loans data
                loadLoansData();
                
            } catch (error) {
                showMessage('error', 'Payment Error', 'Failed to record payment: ' + error.message);
                console.error('Error recording payment:', error);
                logDebug('Error recording payment:', error.message);
            } finally {
                hideLoading();
            }
        }
        
        // Test Firebase connection and data access
        async function testFirebaseConnection() {
            showLoading('Testing Firebase connection...');
            logDebug('Testing Firebase connection...');
            
            try {
                // Test if we can access the users collection
                const usersSnapshot = await db.collection('users').limit(1).get();
                logDebug(`Users collection accessible: ${!usersSnapshot.empty}`);
                
                if (usersSnapshot.empty) {
                    logDebug('No users found in database');
                    hideLoading();
                    return false;
                }
                
                // Test if we can access loans for the first user
                const firstUser = usersSnapshot.docs[0];
                const loansSnapshot = await db.collection('users')
                    .doc(firstUser.id)
                    .collection('loans')
                    .limit(1)
                    .get();
                
                logDebug(`Loans subcollection accessible for user ${firstUser.id}: ${!loansSnapshot.empty}`);
                
                if (!loansSnapshot.empty) {
                    const loanData = loansSnapshot.docs[0].data();
                    logDebug('Sample loan data:', JSON.stringify(loanData, null, 2));
                }
                
                hideLoading();
                return true;
                
            } catch (error) {
                logDebug('Firebase connection error:', error.message);
                hideLoading();
                return false;
            }
        }
        
        // Load loans data with improved error handling
        async function loadLoansData() {
            showLoading('Loading loans...');
            logDebug('Starting to load loans from Firebase...');
            
            try {
                // Get all users
                const usersSnapshot = await db.collection('users').get();
                logDebug(`Found ${usersSnapshot.size} users in database`);
                
                if (usersSnapshot.empty) {
                    document.getElementById('loans-table-body').innerHTML = `
                        <tr>
                            <td colspan="7" class="px-6 py-4 text-center text-gray-500">
                                No users found in database.
                            </td>
                        </tr>
                    `;
                    hideLoading();
                    return;
                }
                
                allLoans = [];
                let totalLoans = 0;
                let activeLoans = 0;
                let pendingLoans = 0;
                let totalLoanValue = 0;
                
                // Process each user's loans
                const loanPromises = [];
                
                usersSnapshot.forEach((userDoc) => {
                    const userData = userDoc.data();
                    const userLoanPromise = db.collection('users')
                        .doc(userDoc.id)
                        .collection('loans')
                        .get()
                        .then((loansSnapshot) => {
                            logDebug(`User ${userDoc.id} has ${loansSnapshot.size} loans`);
                            
                            loansSnapshot.forEach((loanDoc) => {
                                const loan = loanDoc.data();
                                loan.id = loanDoc.id;
                                loan.userId = userDoc.id;
                                loan.userName = userData.fullName || userData.name || userData.email || 'Unknown User';
                                allLoans.push(loan);
                                
                                totalLoans++;
                                if (loan.status === 'Active') activeLoans++;
                                if (loan.status === 'Pending') pendingLoans++;
                                totalLoanValue += parseFloat(loan.loanAmount) || 0;
                            });
                        })
                        .catch((error) => {
                            logDebug(`Error loading loans for user ${userDoc.id}:`, error.message);
                        });
                    
                    loanPromises.push(userLoanPromise);
                });
                
                // Wait for all loans to be loaded
                await Promise.all(loanPromises);
                logDebug(`Total loans loaded: ${allLoans.length}`);
                
                // Update summary cards
                document.getElementById('total-loans').textContent = totalLoans;
                document.getElementById('active-loans').textContent = activeLoans;
                document.getElementById('pending-loans').textContent = pendingLoans;
                document.getElementById('total-loan-value').textContent = formatCurrency(totalLoanValue);
                
                if (allLoans.length === 0) {
                    document.getElementById('loans-table-body').innerHTML = `
                        <tr>
                            <td colspan="7" class="px-6 py-4 text-center text-gray-500">
                                No loans found in database. Check if users have loans subcollections.
                            </td>
                        </tr>
                    `;
                    hideLoading();
                    return;
                }
                
                // Sort loans by application date (newest first)
                allLoans.sort((a, b) => {
                    const dateA = a.applicationDate ? (a.applicationDate.toDate ? a.applicationDate.toDate() : new Date(a.applicationDate)) : new Date(0);
                    const dateB = b.applicationDate ? (b.applicationDate.toDate ? b.applicationDate.toDate() : new Date(b.applicationDate)) : new Date(0);
                    return dateB - dateA;
                });
                
                // Render loans table
                let loansHtml = '';
                allLoans.forEach((loan) => {
                    const loanAmount = parseFloat(loan.loanAmount || 0);
                    const outstanding = parseFloat(loan.outstandingBalance || loanAmount);
                    const paid = loanAmount - outstanding;
                    const progress = loanAmount > 0 ? (paid / loanAmount) * 100 : 0;
                    
                    loansHtml += `
                        <tr>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="font-medium">${loan.userName}</div>
                                <div class="text-sm text-gray-500">${loan.idNumber || 'N/A'}</div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="font-medium">${formatCurrency(loanAmount)}</div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="font-medium outstanding-balance" data-user-id="${loan.userId}" data-loan-id="${loan.id}">
                                    ${formatCurrency(outstanding)}
                                </div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="text-sm">
                                    <div class="flex justify-between text-xs text-gray-600">
                                        <span>Paid: ${formatCurrency(paid)}</span>
                                        <span>${progress.toFixed(1)}%</span>
                                    </div>
                                    <div class="progress-bar">
                                        <div class="progress-fill" style="width: ${progress}%"></div>
                                    </div>
                                </div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span class="status-badge ${getStatusClass(loan.status)}">
                                    ${loan.status || 'N/A'}
                                </span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="text-sm text-gray-500">${formatDate(loan.applicationDate)}</div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                <button class="text-blue-600 hover:text-blue-900 mr-2 view-loan" data-user-id="${loan.userId}" data-loan-id="${loan.id}" title="View Loan Details">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="text-purple-600 hover:text-purple-900 mr-2 payment-history-btn" data-user-id="${loan.userId}" data-loan-id="${loan.id}" title="View Payment History">
                                    <i class="fas fa-history"></i>
                                </button>
                                <button class="text-green-600 hover:text-green-900 payment-btn" data-user-id="${loan.userId}" data-loan-id="${loan.id}" title="Record Payment">
                                    <i class="fas fa-money-bill-wave"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                });
                
                document.getElementById('loans-table-body').innerHTML = loansHtml;
                
                // Add event listeners to view buttons
                document.querySelectorAll('.view-loan').forEach(button => {
                    button.addEventListener('click', () => {
                        const userId = button.getAttribute('data-user-id');
                        const loanId = button.getAttribute('data-loan-id');
                        viewLoanDetails(userId, loanId);
                    });
                });
                
                // Add event listeners to payment buttons
                document.querySelectorAll('.payment-btn').forEach(button => {
                    button.addEventListener('click', () => {
                        const userId = button.getAttribute('data-user-id');
                        const loanId = button.getAttribute('data-loan-id');
                        const loan = allLoans.find(l => l.userId === userId && l.id === loanId);
                        if (loan) openPaymentModal(loan);
                    });
                });
                
                // Add event listeners to payment history buttons
                document.querySelectorAll('.payment-history-btn').forEach(button => {
                    button.addEventListener('click', () => {
                        const userId = button.getAttribute('data-user-id');
                        const loanId = button.getAttribute('data-loan-id');
                        viewPaymentHistory(userId, loanId);
                    });
                });
                
                // Add event listeners to outstanding balance cells
                document.querySelectorAll('.outstanding-balance').forEach(cell => {
                    cell.addEventListener('click', () => {
                        const userId = cell.getAttribute('data-user-id');
                        const loanId = cell.getAttribute('data-loan-id');
                        const loan = allLoans.find(l => l.userId === userId && l.id === loanId);
                        if (loan) openPaymentModal(loan);
                    });
                });
                
            } catch (error) {
                const errorMsg = 'Failed to load loans: ' + error.message;
                showMessage('error', 'Data Error', errorMsg);
                console.error('Error loading loans:', error);
                logDebug('Error loading loans:', error.message);
                
                document.getElementById('loans-table-body').innerHTML = `
                    <tr>
                        <td colspan="7" class="px-6 py-4 text-center text-red-500">
                            ${errorMsg}
                        </td>
                    </tr>
                `;
            } finally {
                hideLoading();
            }
        }
        
        // Event listeners for modals
        document.getElementById('close-view-modal').addEventListener('click', () => {
            loanViewModal.classList.add('hidden');
        });
        
        document.getElementById('close-view-modal-btn').addEventListener('click', () => {
            loanViewModal.classList.add('hidden');
        });
        
        document.getElementById('close-payment-modal').addEventListener('click', () => {
            paymentModal.classList.add('hidden');
        });
        
        document.getElementById('cancel-payment-btn').addEventListener('click', () => {
            paymentModal.classList.add('hidden');
        });
        
        document.getElementById('save-payment-btn').addEventListener('click', savePayment);
        
        document.getElementById('close-payment-history-modal').addEventListener('click', () => {
            paymentHistoryModal.classList.add('hidden');
        });
        
        document.getElementById('close-payment-history-btn').addEventListener('click', () => {
            paymentHistoryModal.classList.add('hidden');
        });
        
        // Toggle debug panel
        document.getElementById('debug-toggle').addEventListener('click', function() {
            debugPanel.classList.toggle('hidden');
        });
        
        // Logout functionality
        document.getElementById('logout-btn').addEventListener('click', function() {
            auth.signOut().then(() => {
                window.location.href = '../index.html';
            }).catch((error) => {
                showMessage('error', 'Logout Error', error.message);
                console.error('Error signing out:', error);
                logDebug('Error signing out:', error.message);
            });
        });
        
        // Initialize the dashboard
        document.addEventListener('DOMContentLoaded', function() {
            // Test Firebase connection first
            testFirebaseConnection().then((connected) => {
                if (connected) {
                    logDebug('Firebase connection successful. Loading loans...');
                    loadLoansData();
                } else {
                    showMessage('error', 'Connection Error', 'Could not connect to Firebase. Check console for details.');
                    logDebug('Firebase connection failed. Please check your configuration and security rules.');
                }
            });
        });
    </script>
</body>
</html>